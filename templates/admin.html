<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - Fitness Tracker</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
        }
        .stat-card p {
            font-size: 32px;
            font-weight: bold;
            margin: 0;
            color: #007bff;
        }
        .admin-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .user-table th, .user-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .user-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        .user-table tr:hover {
            background: #f8f9fa;
        }
        .role-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .role-admin {
            background: #ff6b6b;
            color: white;
        }
        .role-user {
            background: #51cf66;
            color: white;
        }
        .user-actions {
            display: flex;
            gap: 8px;
        }
    </style>
</head>
<body>
    <nav>
        <a href="/" class="logo">üëë Fitness Tracker Admin</a>
        <div class="nav-links">
            <a href="/dashboard">üìã –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</a>
            <a href="/admin" class="active">üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
            <div class="user-info">
                <span>üëë {{ current_user.username }} (admin)</span>
                <a href="/logout" class="btn-logout">üö™ –í—ã–π—Ç–∏</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1>üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
        
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="admin-stats">
            <div class="stat-card">
                <h3>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                <p>{{ stats.total_users }}</p>
            </div>
            <div class="stat-card">
                <h3>–í—Å–µ–≥–æ –ø–ª–∞–Ω–æ–≤</h3>
                <p>{{ stats.total_plans }}</p>
            </div>
            <div class="stat-card">
                <h3>–í—Å–µ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</h3>
                <p>{{ stats.total_exercises }}</p>
            </div>
        </div>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
        <div class="admin-section">
            <h2>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
            <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</p>
            <div id="usersTableContainer"></div>
        </div>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞–Ω–∞–º–∏ -->
        <div class="admin-section">
            <h2>üìã –í—Å–µ –ø–ª–∞–Ω—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h2>
            <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–ª–∞–Ω—ã...</p>
            <div id="plansTableContainer"></div>
        </div>
    </div>

    <script>
        const token = "{{ token }}";
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users', {
                    headers: {'Authorization': 'Bearer ' + token}
                });
                
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
                
                const users = await response.json();
                const container = document.getElementById('usersTableContainer');
                
                if (users.length === 0) {
                    container.innerHTML = '<p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
                    return;
                }
                
                let html = '<table class="user-table"><thead><tr>' +
                    '<th>ID</th><th>–ò–º—è</th><th>Email</th><th>–†–æ–ª—å</th>' +
                    '<th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>';
                
                users.forEach(user => {
                    const regDate = new Date(user.created_at).toLocaleDateString('ru-RU');
                    const roleClass = user.role === 'admin' ? 'role-admin' : 'role-user';
                    const roleText = user.role === 'admin' ? 'üëë –ê–¥–º–∏–Ω' : 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                    
                    html += `
                    <tr>
                        <td>${user.id}</td>
                        <td><strong>${user.username}</strong><br><small>${user.full_name || ''}</small></td>
                        <td>${user.email}</td>
                        <td><span class="role-badge ${roleClass}">${roleText}</span></td>
                        <td>${regDate}</td>
                        <td>
                            <div class="user-actions">
                                <button class="btn btn-sm" onclick="changeUserRole(${user.id}, '${user.role}')">
                                    ${user.role === 'admin' ? 'üë§ –°–¥–µ–ª–∞—Ç—å user' : 'üëë –°–¥–µ–ª–∞—Ç—å admin'}
                                </button>
                                <!-- –†–ê–ë–û–¢–ê–Æ–©–ê–Ø –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
                                <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id}, '${user.username}')">
                                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </div>
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('usersTableContainer').innerHTML = 
                    '<div class="message error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
            }
        }
        
        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function changeUserRole(userId, currentRole) {
            const newRole = currentRole === 'admin' ? 'user' : 'admin';
            
            if (!confirm(`–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ "${newRole}"?`)) return;
            
            try {
                const response = await fetch(`/api/admin/users/${userId}/role`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ role: newRole })
                });
                
                if (response.ok) {
                    alert('–†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑–º–µ–Ω–µ–Ω–∞');
                    loadUsers();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–æ–ª–∏');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–æ–ª–∏');
            }
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–†–ê–ë–û–¢–ê–ï–¢ - endpoint –µ—Å—Ç—å)
        async function deleteUser(userId, username) {
            if (!confirm(`–í–ù–ò–ú–ê–ù–ò–ï! –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${username}" –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ —É–¥–∞–ª–µ–Ω–∏—é –≤—Å–µ—Ö –µ–≥–æ –ø–ª–∞–Ω–æ–≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: {'Authorization': 'Bearer ' + token}
                });
                
                if (response.ok) {
                    alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω');
                    loadUsers();
                } else {
                    const error = await response.json();
                    alert(`–û—à–∏–±–∫–∞: ${error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –ø–ª–∞–Ω—ã –¥–ª—è –∞–¥–º–∏–Ω–∞
        async function loadAllPlans() {
            try {
                const response = await fetch('/api/admin/workout-plans', {
                    headers: {'Authorization': 'Bearer ' + token}
                });
                
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞–Ω–æ–≤');
                
                const plans = await response.json();
                const container = document.getElementById('plansTableContainer');
                
                if (plans.length === 0) {
                    container.innerHTML = '<p>–ü–ª–∞–Ω–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
                    return;
                }
                
                let html = '<table class="user-table"><thead><tr>' +
                    '<th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–í–ª–∞–¥–µ–ª–µ—Ü</th><th>–°–ª–æ–∂–Ω–æ—Å—Ç—å</th>' +
                    '<th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>';
                
                plans.forEach(plan => {
                    const createdDate = new Date(plan.created_at).toLocaleDateString('ru-RU');
                    const status = plan.is_public ? 'üåç –ü—É–±–ª–∏—á–Ω—ã–π' : 'üîí –ü—Ä–∏–≤–∞—Ç–Ω—ã–π';
                    const difficulty = plan.difficulty || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
                    
                    html += `
                    <tr>
                        <td>${plan.id}</td>
                        <td><strong>${plan.title}</strong></td>
                        <td>ID: ${plan.owner_id}</td>
                        <td>${difficulty}</td>
                        <td>${status}</td>
                        <td>${createdDate}</td>
                        <td>
                            <div class="user-actions">
                                <a href="/plan/${plan.id}" class="btn btn-sm">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä</a>
                                <!-- –†–ê–ë–û–¢–ê–Æ–©–ê–Ø –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–ª–∞–Ω–∞ –∞–¥–º–∏–Ω–æ–º -->
                                <button class="btn btn-sm btn-danger" onclick="deleteAdminPlan(${plan.id}, '${plan.title}')">
                                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </div>
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('plansTableContainer').innerHTML = 
                    '<div class="message error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞–Ω–æ–≤</div>';
            }
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –∞–¥–º–∏–Ω–æ–º (–†–ê–ë–û–¢–ê–ï–¢ - endpoint –µ—Å—Ç—å)
        async function deleteAdminPlan(planId, planTitle) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ "${planTitle}"?`)) return;
            
            try {
                const response = await fetch(`/api/admin/workout-plans/${planId}`, {
                    method: 'DELETE',
                    headers: {'Authorization': 'Bearer ' + token}
                });
                
                if (response.ok) {
                    alert('–ü–ª–∞–Ω —É–¥–∞–ª–µ–Ω');
                    loadAllPlans();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–ª–∞–Ω–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–ª–∞–Ω–∞');
            }
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            loadUsers();
            loadAllPlans();
        };
    </script>
</body>
</html>