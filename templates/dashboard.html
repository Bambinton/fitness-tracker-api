<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–π –∫–∞–±–∏–Ω–µ—Ç - Fitness Tracker</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav>
        <a href="/" class="logo">
            <i class="fas fa-dumbbell"></i> Fitness Tracker
        </a>
        <div class="nav-links">
            <a href="/dashboard" class="active">
                <i class="fas fa-clipboard-list"></i> –ú–æ–∏ –ø–ª–∞–Ω—ã
            </a>
            {% if current_user.role == 'admin' %}
            <a href="/admin">
                <i class="fas fa-crown"></i> –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
            </a>
            {% endif %}
            <div class="user-info">
                <span><i class="fas fa-user-circle"></i> {{ current_user.username }}</span>
                <a href="/logout" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
                </a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ -->
        <div class="section-header" style="margin-bottom: 30px;">
            <div>
                <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ current_user.username }}! üëã</h1>
                <p style="color: #666; margin-top: 5px;">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–≤–æ–∏–º–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–º–∏ –ø–ª–∞–Ω–∞–º–∏</p>
            </div>
            <button class="btn btn-primary" onclick="showCreatePlanModal()">
                <i class="fas fa-plus-circle"></i> –ù–æ–≤—ã–π –ø–ª–∞–Ω
            </button>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats">
            <div class="stat-card">
                <div style="font-size: 24px; margin-bottom: 10px; color: #667eea;">
                    <i class="fas fa-clipboard-list"></i>
                </div>
                <h3>–í—Å–µ–≥–æ –ø–ª–∞–Ω–æ–≤</h3>
                <p id="totalPlans">0</p>
            </div>
            <div class="stat-card">
                <div style="font-size: 24px; margin-bottom: 10px; color: #667eea;">
                    <i class="fas fa-dumbbell"></i>
                </div>
                <h3>–í—Å–µ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</h3>
                <p id="totalExercises">0</p>
            </div>
            <div class="stat-card">
                <div style="font-size: 24px; margin-bottom: 10px; color: #667eea;">
                    <i class="fas fa-globe"></i>
                </div>
                <h3>–ü—É–±–ª–∏—á–Ω—ã–µ –ø–ª–∞–Ω—ã</h3>
                <p id="publicPlans">0</p>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –ø–ª–∞–Ω–æ–≤ -->
        <div class="section-header" style="margin-top: 40px;">
            <h2><i class="fas fa-list-alt"></i> –ú–æ–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–µ –ø–ª–∞–Ω—ã</h2>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="loadStats()">
                    <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                </button>
            </div>
        </div>

        <div id="plansList">
            {% if plans %}
                {% for plan in plans %}
                <div class="plan-card">
                    <div class="plan-header">
                        <div>
                            <h3>{{ plan.title }}</h3>
                            <div style="display: flex; gap: 10px; margin-top: 5px; flex-wrap: wrap;">
                                <span class="difficulty-badge {{ plan.difficulty }}">
                                    {% if plan.difficulty == 'beginner' %}<i class="fas fa-seedling"></i> –ù–∞—á–∏–Ω–∞—é—â–∏–π
                                    {% elif plan.difficulty == 'intermediate' %}<i class="fas fa-chart-line"></i> –°—Ä–µ–¥–Ω–∏–π
                                    {% elif plan.difficulty == 'advanced' %}<i class="fas fa-fire"></i> –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π
                                    {% else %}<i class="fas fa-question"></i> –ù–µ —É–∫–∞–∑–∞–Ω–æ{% endif %}
                                </span>
                                <span style="color: #888; font-size: 14px;">
                                    <i class="far fa-clock"></i> {{ plan.duration_weeks or 0 }} –Ω–µ–¥–µ–ª—å
                                </span>
                            </div>
                        </div>
                        <span style="color: #888; font-size: 14px;">
                            <i class="far fa-calendar"></i> {{ plan.created_at.strftime('%d.%m.%Y') }}
                        </span>
                    </div>
                    
                    {% if plan.description %}
                    <div class="plan-description">
                        <p>{{ plan.description }}</p>
                    </div>
                    {% endif %}
                    
                    <div class="plan-info">
                        <span>
                            <i class="fas fa-user"></i> –í–ª–∞–¥–µ–ª–µ—Ü: {{ current_user.username }}
                        </span>
                        <span>
                            {% if plan.is_public %}
                                <i class="fas fa-globe" style="color: #51cf66;"></i> –ü—É–±–ª–∏—á–Ω—ã–π
                            {% else %}
                                <i class="fas fa-lock" style="color: #ff6b6b;"></i> –ü—Ä–∏–≤–∞—Ç–Ω—ã–π
                            {% endif %}
                        </span>
                    </div>
                    
                    <div class="plan-actions">
                        <a href="/plan/{{ plan.id }}" class="btn btn-primary">
                            <i class="fas fa-eye"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä
                        </a>
                        <button class="btn btn-danger" onclick="deletePlan({{ plan.id }}, '{{ plan.title }}')">
                            <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <div style="font-size: 60px; color: #ddd; margin-bottom: 20px;">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <h3 style="color: #888; margin-bottom: 15px;">–£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –ø–ª–∞–Ω–æ–≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h3>
                    <p style="color: #aaa; margin-bottom: 25px;">–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –ø–ª–∞–Ω, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</p>
                    <button class="btn btn-primary" onclick="showCreatePlanModal()" style="padding: 15px 30px;">
                        <i class="fas fa-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –ø–ª–∞–Ω
                    </button>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞–Ω–∞ -->
    <div id="createPlanModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="margin: 0;"><i class="fas fa-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–ª–∞–Ω</h2>
                <button onclick="closeCreatePlanModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #888;">&times;</button>
            </div>
            
            <form id="createPlanForm">
                <div style="margin-bottom: 20px;">
                    <label for="title" style="display: block; margin-bottom: 8px; color: #555; font-weight: 500;">
                        <i class="fas fa-heading"></i> –ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ *
                    </label>
                    <input type="text" id="title" name="title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–æ–≥—Ä–∞–º–º–∞ –¥–ª—è –Ω–∞–±–æ—Ä–∞ –º–∞—Å—Å—ã" required>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label for="description" style="display: block; margin-bottom: 8px; color: #555; font-weight: 500;">
                        <i class="fas fa-align-left"></i> –û–ø–∏—Å–∞–Ω–∏–µ
                    </label>
                    <textarea id="description" name="description" placeholder="–û–ø–∏—à–∏—Ç–µ —Ü–µ–ª—å –ø–ª–∞–Ω–∞, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏..."></textarea>
                </div>
                
                <div class="form-row">
                    <div>
                        <label for="difficulty" style="display: block; margin-bottom: 8px; color: #555; font-weight: 500;">
                            <i class="fas fa-chart-line"></i> –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
                        </label>
                        <select id="difficulty" name="difficulty">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å</option>
                            <option value="beginner">üü¢ –ù–∞—á–∏–Ω–∞—é—â–∏–π</option>
                            <option value="intermediate">üü° –°—Ä–µ–¥–Ω–∏–π</option>
                            <option value="advanced">üî¥ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="duration_weeks" style="display: block; margin-bottom: 8px; color: #555; font-weight: 500;">
                            <i class="far fa-calendar-alt"></i> –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–Ω–µ–¥–µ–ª—å)
                        </label>
                        <input type="number" id="duration_weeks" name="duration_weeks" placeholder="4" min="1" max="52">
                    </div>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="is_public" name="is_public">
                        <span>
                            <i class="fas fa-globe"></i> –°–¥–µ–ª–∞—Ç—å –ø–ª–∞–Ω –ø—É–±–ª–∏—á–Ω—ã–º
                        </span>
                    </label>
                    <small style="color: #888; margin-left: 30px; display: block; margin-top: 5px;">
                        –ü—É–±–ª–∏—á–Ω—ã–µ –ø–ª–∞–Ω—ã –≤–∏–¥–Ω—ã –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
                    </small>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeCreatePlanModal()">
                        <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i> –°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
    const token = "{{ token }}";
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    async function loadStats() {
        try {
            const response = await fetch('/api/stats', {
                headers: {'Authorization': `Bearer ${token}`}
            });
            if (response.ok) {
                const stats = await response.json();
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ë–ï–ó –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
                document.getElementById('totalPlans').textContent = stats.total_plans;
                document.getElementById('totalExercises').textContent = stats.total_exercises;
                document.getElementById('publicPlans').textContent = stats.public_plans;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            showMessage('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
        }
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –ø–ª–∞–Ω–∞
    async function deletePlan(planId, planTitle) {
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–ª–∞–Ω "${planTitle}"?\n–í—Å–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤ –ø–ª–∞–Ω–µ —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.`)) return;
        
        try {
            const response = await fetch(`/api/workout-plans/${planId}`, {
                method: 'DELETE',
                headers: {'Authorization': `Bearer ${token}`}
            });
            
            if (response.ok) {
                showMessage('success', '–ü–ª–∞–Ω —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω');
                setTimeout(() => location.reload(), 1500);
            } else {
                showMessage('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–ª–∞–Ω–∞');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            showMessage('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–ª–∞–Ω–∞');
        }
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    function showMessage(type, text) {
        const message = document.createElement('div');
        message.className = `message ${type}`;
        message.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            <span>${text}</span>
        `;
        
        document.querySelector('.container').prepend(message);
        
        setTimeout(() => {
            message.remove();
        }, 5000);
    }
    
    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞–Ω–∞
    function showCreatePlanModal() {
        document.getElementById('createPlanModal').style.display = 'flex';
        document.getElementById('title').focus();
    }
    
    function closeCreatePlanModal() {
        document.getElementById('createPlanModal').style.display = 'none';
        document.getElementById('createPlanForm').reset();
    }
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–ª–∞–Ω–∞
    document.getElementById('createPlanForm').onsubmit = async function(e) {
        e.preventDefault();
        
        const planData = {
            title: document.getElementById('title').value,
            description: document.getElementById('description').value,
            difficulty: document.getElementById('difficulty').value || null,
            duration_weeks: document.getElementById('duration_weeks').value ? 
                parseInt(document.getElementById('duration_weeks').value) : null,
            is_public: document.getElementById('is_public').checked
        };
        
        try {
            const response = await fetch('/api/workout-plans/', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(planData)
            });
            
            if (response.ok) {
                showMessage('success', '–ü–ª–∞–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
                closeCreatePlanModal();
                setTimeout(() => location.reload(), 1500);
            } else {
                const error = await response.json();
                showMessage('error', error.detail || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞–Ω–∞');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            showMessage('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞–Ω–∞');
        }
    };
    
    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ –∏–ª–∏ Escape
    window.onclick = function(event) {
        const modal = document.getElementById('createPlanModal');
        if (event.target === modal) {
            closeCreatePlanModal();
        }
    };
    
    window.onkeydown = function(event) {
        if (event.key === 'Escape') {
            closeCreatePlanModal();
        }
    };
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.onload = loadStats;
</script>
</body>
</html>