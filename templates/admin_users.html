<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .user-actions {
            display: flex;
            gap: 8px;
        }
        .status-active {
            color: green;
            font-weight: bold;
        }
        .status-inactive {
            color: red;
            font-weight: bold;
        }
        .search-box {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <a href="/admin" class="logo">üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
            <div class="nav-links">
                <a href="/admin">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
                <a href="/admin/users" class="active">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
                <a href="/admin/plans">üìã –ü–ª–∞–Ω—ã</a>
                <div class="user-info">
                    <span>üëë {{ current_user.username }}</span>
                    <a href="/logout" class="btn-logout">üö™ –í—ã–π—Ç–∏</a>
                </div>
            </div>
        </nav>

        <h1>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h1>
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ email –∏–ª–∏ –∏–º–µ–Ω–∏..." 
                   style="width: 300px; padding: 10px;">
            <select id="roleFilter" style="padding: 10px; margin-left: 10px;">
                <option value="">–í—Å–µ —Ä–æ–ª–∏</option>
                <option value="user">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                <option value="admin">üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</option>
            </select>
            <select id="statusFilter" style="padding: 10px; margin-left: 10px;">
                <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                <option value="true">‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                <option value="false">‚ùå –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
            </select>
            <button onclick="searchUsers()" class="btn">üîç –ü–æ–∏—Å–∫</button>
        </div>

        <div id="usersTableContainer">
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</p>
        </div>

        <div style="margin-top: 30px; padding: 20px; background: #f1f8ff; border-radius: 10px;">
            <h3>üìù –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∞–¥–º–∏–Ω)</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <input type="email" id="newUserEmail" placeholder="Email">
                <input type="text" id="newUserUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                <input type="text" id="newUserFullName" placeholder="–ü–æ–ª–Ω–æ–µ –∏–º—è">
                <input type="password" id="newUserPassword" placeholder="–ü–∞—Ä–æ–ª—å">
                <select id="newUserRole" style="padding: 10px;">
                    <option value="user">üë§ –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                    <option value="admin">üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                </select>
                <button onclick="createAdminUser()" class="btn btn-primary">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
            </div>
        </div>
    </div>

    <script>
        let token = "{{ token }}";
        
        async function loadUsers(filters = {}) {
            try {
                let url = '/api/admin/users?';
                if (filters.search) url += `search=${filters.search}&`;
                if (filters.role) url += `role=${filters.role}&`;
                if (filters.is_active !== undefined) url += `is_active=${filters.is_active}&`;
                
                const response = await fetch(url, {
                    headers: {'Authorization': 'Bearer ' + token}
                });
                
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                
                const users = await response.json();
                const container = document.getElementById('usersTableContainer');
                
                if (users.length === 0) {
                    container.innerHTML = '<p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
                    return;
                }
                
                let html = '<table class="user-table"><thead><tr>' +
                    '<th>ID</th><th>–ò–º—è</th><th>Email</th><th>–†–æ–ª—å</th>' +
                    '<th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>';
                
                users.forEach(user => {
                    const regDate = new Date(user.created_at).toLocaleDateString('ru-RU');
                    const roleText = user.role === 'admin' ? 'üëë –ê–¥–º–∏–Ω' : 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                    const statusText = user.is_active ? 
                        '<span class="status-active">‚úÖ –ê–∫—Ç–∏–≤–µ–Ω</span>' : 
                        '<span class="status-inactive">‚ùå –ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>';
                    
                    html += `
                    <tr>
                        <td>${user.id}</td>
                        <td><strong>${user.username}</strong><br><small>${user.full_name || ''}</small></td>
                        <td>${user.email}</td>
                        <td>${roleText}</td>
                        <td>${statusText}</td>
                        <td>${regDate}</td>
                        <td>
                            <div class="user-actions">
                                <button class="btn btn-sm" onclick="toggleUserRole(${user.id}, '${user.role}')">
                                    ${user.role === 'admin' ? 'üë§ –°–¥–µ–ª–∞—Ç—å user' : 'üëë –°–¥–µ–ª–∞—Ç—å admin'}
                                </button>
                                <button class="btn btn-sm" onclick="toggleUserStatus(${user.id}, ${user.is_active})">
                                    ${user.is_active ? '‚ùå –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">
                                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </div>
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('usersTableContainer').innerHTML = 
                    '<div class="message error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
            }
        }
        
        async function toggleUserRole(userId, currentRole) {
            const newRole = currentRole === 'admin' ? 'user' : 'admin';
            
            if (!confirm(`–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ "${newRole}"?`)) return;
            
            try {
                const response = await fetch(`/api/admin/users/${userId}/role`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ role: newRole })
                });
                
                if (response.ok) {
                    alert('–†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑–º–µ–Ω–µ–Ω–∞');
                    loadUsers();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–æ–ª–∏');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–æ–ª–∏');
            }
        }
        
        async function toggleUserStatus(userId, isActive) {
            const newStatus = !isActive;
            const action = newStatus ? '–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å';
            
            if (!confirm(`${action.charAt(0).toUpperCase() + action.slice(1)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?`)) return;
            
            try {
                const response = await fetch(`/api/admin/users/${userId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: newStatus })
                });
                
                if (response.ok) {
                    alert(`–°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑–º–µ–Ω–µ–Ω`);
                    loadUsers();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
            }
        }
        
        async function deleteUser(userId) {
            if (!confirm('–í–ù–ò–ú–ê–ù–ò–ï! –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ —É–¥–∞–ª–µ–Ω–∏—é –≤—Å–µ—Ö –µ–≥–æ –ø–ª–∞–Ω–æ–≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: {'Authorization': 'Bearer ' + token}
                });
                
                if (response.ok) {
                    alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω');
                    loadUsers();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }
        }
        
        async function createAdminUser() {
            const email = document.getElementById('newUserEmail').value;
            const username = document.getElementById('newUserUsername').value;
            const fullName = document.getElementById('newUserFullName').value;
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;
            
            if (!email || !username || !password) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: email, –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/users/create', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        username: username,
                        full_name: fullName || null,
                        password: password,
                        role: role
                    })
                });
                
                if (response.ok) {
                    alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω');
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('newUserEmail').value = '';
                    document.getElementById('newUserUsername').value = '';
                    document.getElementById('newUserFullName').value = '';
                    document.getElementById('newUserPassword').value = '';
                    loadUsers();
                } else {
                    const error = await response.json();
                    alert(`–û—à–∏–±–∫–∞: ${error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }
        }
        
        function searchUsers() {
            const search = document.getElementById('searchInput').value;
            const role = document.getElementById('roleFilter').value;
            const status = document.getElementById('statusFilter').value;
            
            const filters = {};
            if (search) filters.search = search;
            if (role) filters.role = role;
            if (status !== '') filters.is_active = status === 'true';
            
            loadUsers(filters);
        }
        
        window.onload = () => loadUsers();
    </script>
</body>
</html>